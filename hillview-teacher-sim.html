<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hillview Middle School Teacher Simulator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Be a Hillview Middle School teacher for a year. Balance learning, likability, and enrollment across 11 key months." />

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3THX5NYY2B"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-3THX5NYY2B');
  </script>

  <style>
    :root {
      color-scheme: dark;
      --bg: #020617;
      --card-bg: #020617;
      --card-border: rgba(148, 163, 184, 0.5);
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.18);
      --text: #f9fafb;
      --muted: #9ca3af;
      --danger: #f97373;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top left, #1e293b 0, transparent 55%),
        radial-gradient(circle at top right, #111827 0, transparent 60%),
        var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .app {
      max-width: 960px;
      width: 100%;
      background: rgba(2, 6, 23, 0.98);
      border-radius: 24px;
      padding: 20px 18px 18px;
      box-shadow:
        0 22px 45px rgba(0, 0, 0, 0.7),
        0 0 0 1px rgba(148, 163, 184, 0.22);
      backdrop-filter: blur(18px);
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .title-group h1 {
      margin: 0;
      font-size: 1.6rem;
    }

    .title-group p {
      margin: 3px 0 0;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .badge {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: var(--muted);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.15fr);
      gap: 16px;
    }

    .panel {
      background: var(--card-bg);
      border-radius: 18px;
      border: 1px solid var(--card-border);
      padding: 13px 13px 12px;
    }

    .panel-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .panel-title {
      font-size: 0.9rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .panel-subtitle {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .start-screen {
      display: flex;
      gap: 16px;
      flex-direction: column;
    }

    .start-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    label {
      font-size: 0.82rem;
      color: var(--muted);
    }

    select {
      background: #020617;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 6px 10px;
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
    }

    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.6);
    }

    .primary-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-weight: 600;
      font-size: 0.87rem;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), #16a34a);
      color: #01110a;
      box-shadow: 0 14px 26px rgba(34, 197, 94, 0.45);
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out;
    }

    .primary-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 34px rgba(34, 197, 94, 0.55);
    }

    .primary-btn:active {
      transform: translateY(0);
      box-shadow: 0 10px 18px rgba(34, 197, 94, 0.4);
    }

    .primary-btn[disabled] {
      opacity: 0.5;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .muted-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 5px 10px;
      font-size: 0.78rem;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
    }

    .scenario-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .scenario-meta {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .pill-soft {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      font-size: 0.75rem;
      color: var(--muted);
    }

    .scenario-text {
      font-size: 0.9rem;
      line-height: 1.5;
      padding: 10px 10px 8px;
      border-radius: 14px;
      background: radial-gradient(circle at top left, #0b1120, #020617);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .options {
      margin-top: 4px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
    }

    .option-btn {
      width: 100%;
      text-align: left;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.92);
      padding: 7px 9px;
      font-size: 0.87rem;
      color: #e5e7eb;
      cursor: pointer;
      transition: background 0.09s ease-out, transform 0.05s ease-out, box-shadow 0.09s ease-out, border-color 0.09s ease-out;
    }

    .option-btn:hover {
      background: rgba(30, 64, 175, 0.55);
      box-shadow: 0 8px 16px rgba(30, 64, 175, 0.45);
    }

    .option-btn.selected {
      border-color: var(--accent);
      background: radial-gradient(circle at top left, var(--accent-soft), rgba(15, 23, 42, 0.98));
      box-shadow: 0 10px 18px rgba(34, 197, 94, 0.35);
    }

    .custom-response {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .custom-response textarea {
      resize: vertical;
      min-height: 60px;
      max-height: 160px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: #020617;
      color: var(--text);
      padding: 8px 9px;
      font-size: 0.85rem;
      outline: none;
    }

    .custom-response textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.7);
    }

    .custom-hint {
      font-size: 0.72rem;
      color: var(--muted);
    }

    .scenario-footer {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .scenario-footer-left {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .stat-block {
      background: radial-gradient(circle at top left, #020617, #020617);
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 8px 9px 9px;
      font-size: 0.78rem;
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
      gap: 6px;
    }

    .stat-label {
      color: var(--muted);
      font-size: 0.78rem;
    }

    .stat-value {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .stat-bar {
      position: relative;
      width: 100%;
      height: 7px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
    }

    .stat-bar-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, var(--accent), #22c55e);
      transition: width 0.25s ease-out;
    }

    .stat-extra {
      margin-top: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.72rem;
      color: var(--muted);
    }

    .log {
      margin-top: 6px;
      max-height: 136px;
      overflow-y: auto;
      padding-right: 4px;
      font-size: 0.76rem;
      color: var(--muted);
    }

    .log-item {
      margin-bottom: 4px;
    }

    .log-item strong {
      color: #e5e7eb;
      font-weight: 500;
    }

    .end-screen {
      display: none;
      flex-direction: column;
      gap: 10px;
      padding: 10px 9px;
      border-radius: 14px;
      background: radial-gradient(circle at top left, #0b1120, #020617);
      border: 1px solid rgba(148, 163, 184, 0.5);
      margin-top: 6px;
      font-size: 0.85rem;
    }

    .end-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .end-rank {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .end-metric-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
      font-size: 0.8rem;
    }

    .end-footnote {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .error-text {
      color: var(--danger);
      font-size: 0.76rem;
    }

    @media (max-width: 800px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 600px) {
      .app {
        padding: 16px 12px 14px;
        border-radius: 18px;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .title-group h1 {
        font-size: 1.3rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title-group">
        <h1>Hillview Middle School Teacher Simulator</h1>
        <p>August to June: 11 big moments. Can you keep learning high, stay likable, and keep your class?</p>
      </div>
      <div class="badge">Hillview Â· Menlo Park</div>
    </header>

    <div class="layout">
      <!-- Left: Scenario / Start / End -->
      <section class="panel" id="scenario-panel">
        <div class="panel-header">
          <div>
            <div class="panel-title" id="panel-title-label">Setup</div>
            <div class="panel-subtitle" id="panel-subtitle-label">
              Choose your class size. Learning and likability both start at 50 / 100.
            </div>
          </div>
          <button class="muted-btn" id="restart-btn" style="display:none;">Restart year</button>
        </div>

        <div id="start-screen" class="start-screen">
          <div>
            <p style="margin:0 0 8px;font-size:0.9rem;">
              You&rsquo;re a Hillview teacher from August to June. Each month, you face one tricky moment.
            </p>
            <p style="margin:0;font-size:0.82rem;color:var(--muted);">
              You track <strong>Student Learning</strong>, <strong>Likability &amp; Respect</strong>,
              and <strong>Students Remaining in your class</strong>.
            </p>
          </div>

          <div class="start-row">
            <label for="class-size">Class size:</label>
            <select id="class-size">
              <option value="16">16 students (almost chill)</option>
              <option value="22" selected>22 students (realistic)</option>
              <option value="28">28 students (crowded)</option>
              <option value="32">32 students (dungeon mode)</option>
              <option value="36">36 students (why would you do this)</option>
            </select>
          </div>

          <div class="start-row">
            <label>School year:</label>
            <span style="font-size:0.85rem;">11 scenarios Â· August through June</span>
          </div>

          <div class="start-row">
            <button class="primary-btn" id="start-btn">
              Start in August
              <span>â–¶</span>
            </button>
          </div>
        </div>

        <div id="scenario-image" style="margin-bottom: 12px; text-align:center;">
  <img id="scenario-image-img"
       src=""
       alt="scenario illustration"
       style="max-width: 100%; border-radius: 12px; display:none;" />
</div>

<div id="previous-response-image" style="margin-bottom: 12px; text-align:center;">
  <img id="previous-response-image-img"
       src=""
       alt="your previous move"
       style="max-width: 100%; border-radius: 12px; display:none;" />
</div>

            <div class="scenario-footer">
              <div class="scenario-footer-left">
                <span id="feedback-text">Pick an option or write your own response.</span>
              </div>
              <div>
                <button class="primary-btn" id="submit-btn">
                  Submit &amp; see outcome
                </button>
              </div>
            </div>
          </div>

          <div id="end-screen" class="end-screen">
            <div class="end-title">Year Complete &mdash; Teacher Report</div>
            <div class="end-rank" id="end-rank"></div>
            <div class="end-metric-row" id="end-metrics"></div>
            <div class="end-footnote" id="end-footnote"></div>
            <div>
              <button class="primary-btn" id="play-again-btn">Teach another year</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Right: Stats / Log -->
      <aside class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Class Status</div>
            <div class="panel-subtitle">
              Your three scores update each month, plus a running log.
            </div>
          </div>
        </div>

        <div class="stats-grid">
          <!-- Learning -->
          <div class="stat-block">
            <div class="stat-header">
              <div class="stat-label">Student Learning</div>
              <div class="stat-value" id="learning-value">50 / 100</div>
            </div>
            <div class="stat-bar">
              <div class="stat-bar-fill" id="learning-bar" style="width:50%;"></div>
            </div>
            <div class="stat-extra">
              <span id="learning-trend">Game not started yet.</span>
              <span>Higher = more actual learning.</span>
            </div>
          </div>

          <!-- Likability -->
          <div class="stat-block">
            <div class="stat-header">
              <div class="stat-label">Likability &amp; Respect</div>
              <div class="stat-value" id="likability-value">50 / 100</div>
            </div>
            <div class="stat-bar">
              <div class="stat-bar-fill" id="likability-bar" style="width:50%;"></div>
            </div>
            <div class="stat-extra">
              <span id="likability-trend">Game not started yet.</span>
              <span>Higher = kids like you and trust you.</span>
            </div>
          </div>

          <!-- Students remaining -->
          <div class="stat-block">
            <div class="stat-header">
              <div class="stat-label">Students Remaining</div>
              <div class="stat-value" id="students-value">0</div>
            </div>
            <div class="stat-extra">
              <span id="students-trend">No changes yet.</span>
              <span id="students-cap-note"></span>
            </div>
          </div>

          <!-- Progress + log -->
          <div class="stat-block">
            <div class="stat-header">
              <div class="stat-label">Year Progress</div>
              <div class="stat-value" id="progress-value">0 / 11</div>
            </div>
            <div class="stat-extra">
              <span id="difficulty-label">Difficulty: Normal</span>
              <span id="round-mini-label">No month yet</span>
            </div>
            <div class="log" id="log-container"></div>
          </div>
        </div>
      </aside>
    </div>
  </div>
  <script>
    // ===============================
    // Core config
    // ===============================
    const API_BASE = "https://dexter-bain.onrender.com/api/hillview-sim";

    const MONTHS = [
      "August",
      "September",
      "October",
      "November",
      "December",
      "January",
      "February",
      "March",
      "April",
      "May",
      "June"
    ];
    const TOTAL_ROUNDS = MONTHS.length;

    const SCORE_MIN = 0;
    const SCORE_MAX = 100;
    const SCORE_START = 50;

    // ===============================
    // Game state
    // ===============================
    const state = {
      classSize: 22,
      studentsRemaining: 22,
      maxStudents: 22,
      difficultyMultiplier: 1,
      round: 0,
      maxRounds: TOTAL_ROUNDS,
      learningScore: SCORE_START,
      likabilityScore: SCORE_START,
      lastLearningDelta: 0,
      lastLikabilityDelta: 0,
      lastStudentsDelta: 0,
      history: [],
      currentScenario: null,
      usedScenarioIds: [],
      awaitingNextMonth: false
    };

    // ===============================
    // DOM refs
    // ===============================
    const startScreen = document.getElementById("start-screen");
    const scenarioContainer = document.getElementById("scenario-container");
    const restartBtn = document.getElementById("restart-btn");
    const startBtn = document.getElementById("start-btn");
    const submitBtn = document.getElementById("submit-btn");
    const playAgainBtn = document.getElementById("play-again-btn");

    const classSizeSelect = document.getElementById("class-size");
    const scenarioTextEl = document.getElementById("scenario-text");
    const optionsContainer = document.getElementById("options-container");
    const customInput = document.getElementById("custom-input");
    const feedbackText = document.getElementById("feedback-text");

    const roundLabel = document.getElementById("round-label");
    const roundMiniLabel = document.getElementById("round-mini-label");
    const classMetaText = document.getElementById("class-meta-text");
    const difficultyLabel = document.getElementById("difficulty-label");

    const panelTitleLabel = document.getElementById("panel-title-label");
    const panelSubtitleLabel = document.getElementById("panel-subtitle-label");

    const learningValue = document.getElementById("learning-value");
    const learningBar = document.getElementById("learning-bar");
    const learningTrend = document.getElementById("learning-trend");

    const likabilityValue = document.getElementById("likability-value");
    const likabilityBar = document.getElementById("likability-bar");
    const likabilityTrend = document.getElementById("likability-trend");

    const studentsValue = document.getElementById("students-value");
    const studentsTrend = document.getElementById("students-trend");
    const studentsCapNote = document.getElementById("students-cap-note");

    const progressValue = document.getElementById("progress-value");
    const logContainer = document.getElementById("log-container");

    const endScreen = document.getElementById("end-screen");
    const endRank = document.getElementById("end-rank");
    const endMetrics = document.getElementById("end-metrics");
    const endFootnote = document.getElementById("end-footnote");

    // ===============================
    // Helpers
    // ===============================
    function clamp(num, min, max) {
      return Math.max(min, Math.min(max, num));
    }

    function computeDifficultyFromClassSize(size) {
      // 16 -> ~0.85, 36 -> ~1.35
      return 0.85 + (size - 16) * 0.025;
    }

    function difficultyLabelFromMultiplier(mult) {
      if (mult <= 0.95) return "Difficulty: Chill";
      if (mult <= 1.05) return "Difficulty: Normal";
      if (mult <= 1.15) return "Difficulty: Busy";
      if (mult <= 1.25) return "Difficulty: Crowded";
      return "Difficulty: Legendary";
    }

    function formatTrend(delta) {
      if (delta > 12) return `Last move: â–² huge gain (+${delta})`;
      if (delta > 5) return `Last move: â–² strong gain (+${delta})`;
      if (delta > 0) return `Last move: â–² small gain (+${delta})`;
      if (delta === 0) return "Last move: â–¬ no major change";
      if (delta < -12) return `Last move: â–¼ huge drop (${delta})`;
      if (delta < -5) return `Last move: â–¼ strong drop (${delta})`;
      return `Last move: â–¼ small drop (${delta})`;
    }

    function formatStudentTrend(delta) {
      if (delta > 2) return `Enrollment spike: +${delta} students joined.`;
      if (delta > 0) return `Small gain: +${delta} student joined.`;
      if (delta === 0) return "No enrollment change.";
      if (delta < -2) return `${-delta} students left your class. Rough month.`;
      return `${-delta} student left your class.`;
    }

    function appendLogEntry(entry) {
      const div = document.createElement("div");
      div.className = "log-item";
      div.innerHTML = `<strong>${entry.monthLabel}:</strong> ${entry.headline}`;
      logContainer.appendChild(div);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    // ===============================
    // UI updates
    // ===============================
    function updateStatsUI() {
      learningValue.textContent = `${state.learningScore} / 100`;
      likabilityValue.textContent = `${state.likabilityScore} / 100`;

      learningBar.style.width = `${(state.learningScore / 100) * 100}%`;
      likabilityBar.style.width = `${(state.likabilityScore / 100) * 100}%`;

      if (state.round === 0) {
        learningTrend.textContent = "Game not started yet.";
        likabilityTrend.textContent = "Game not started yet.";
        studentsTrend.textContent = "No changes yet.";
      } else {
        learningTrend.textContent = formatTrend(state.lastLearningDelta);
        likabilityTrend.textContent = formatTrend(state.lastLikabilityDelta);
        studentsTrend.textContent = formatStudentTrend(state.lastStudentsDelta);
      }

      studentsValue.textContent = state.studentsRemaining;
      studentsCapNote.textContent = `Started with ${state.classSize}. Max so far: ${state.maxStudents}.`;

      progressValue.textContent = `${state.round} / ${state.maxRounds}`;
      if (state.round > 0 && state.round <= state.maxRounds) {
        roundMiniLabel.textContent = `${MONTHS[state.round - 1]} (${state.round} of ${state.maxRounds})`;
      } else {
        roundMiniLabel.textContent = "No month yet";
      }

      difficultyLabel.textContent = difficultyLabelFromMultiplier(state.difficultyMultiplier);
    }

    function showStartScreen() {
      startScreen.style.display = "flex";
      scenarioContainer.style.display = "none";
      restartBtn.style.display = "none";
      panelTitleLabel.textContent = "Setup";
      panelSubtitleLabel.textContent =
        "Choose your class size. Learning and likability both start at 50 / 100.";
      endScreen.style.display = "none";
    }

    function showScenarioScreen() {
      startScreen.style.display = "none";
      scenarioContainer.style.display = "block";
      restartBtn.style.display = "inline-block";
      panelTitleLabel.textContent = "Live Scenario";
      panelSubtitleLabel.textContent =
        "The AI generates a situation. You decide what to do.";
      endScreen.style.display = "none";
    }

    function showEndScreen() {
      endScreen.style.display = "flex";
      panelTitleLabel.textContent = "Year Complete";
      panelSubtitleLabel.textContent = "See how you did, then try a new year.";
      feedbackText.textContent = "Year finished. Check your report card on the right.";
      feedbackText.classList.remove("error-text");
    }

    function computeFinalRank() {
      const l = state.learningScore;
      const r = state.likabilityScore;
      const enrollRatio = state.studentsRemaining / state.classSize;

      let rank = "";
      let blurb = "";

      if (l >= 85 && r >= 85 && enrollRatio >= 0.95) {
        rank = "ðŸŸ¢ Hillview Legend";
        blurb =
          "Students learned a ton, almost nobody left your class, and parents talk about you in the good way at soccer games.";
      } else if (l >= 80 && r >= 75 && enrollRatio >= 0.9) {
        rank = "ðŸŸ¢ High-Impact Teacher";
        blurb =
          "Youâ€™re demanding and fair. Kids might complain a bit, but the results and relationships are strong.";
      } else if (l >= 70 && r >= 65 && enrollRatio >= 0.85) {
        rank = "ðŸŸ¡ Solid & Growing";
        blurb =
          "Lots went right. A few decisions cost you, but youâ€™re close to elite with some tweaks.";
      } else if (l >= 60 && r >= 55 && enrollRatio >= 0.75) {
        rank = "ðŸŸ¡ Survived the Year";
        blurb =
          "Pretty realistic middle school energy. Wins, losses, a lot of learningâ€”some of it yours.";
      } else if (l >= 45 || r >= 45 || enrollRatio >= 0.6) {
        rank = "ðŸŸ  Chaotic Neutral Teacher";
        blurb =
          "Memorable for sure. Some students thrived, others transferred. Plenty of stories, mixed outcomes.";
      } else {
        rank = "ðŸ”´ Walking Content for Teacher TikTok";
        blurb =
          "Admin, families, and students would all have opinions. On the plus side, you can immediately replay with no HR meeting.";
      }

      return { rank, blurb };
    }

    function renderEndScreen() {
      const { rank, blurb } = computeFinalRank();

      endRank.textContent = rank;
      endMetrics.innerHTML = `
        <span>Learning: <strong>${state.learningScore}</strong> / 100</span>
        <span>Likability: <strong>${state.likabilityScore}</strong> / 100</span>
        <span>Students remaining: <strong>${state.studentsRemaining}</strong> (started with ${state.classSize})</span>
      `;

      const diffLabel = difficultyLabelFromMultiplier(state.difficultyMultiplier);
      endFootnote.textContent =
        `${blurb} You played on ${diffLabel.replace("Difficulty: ", "").toLowerCase()} with ${state.classSize} starting students.`;

      showEndScreen();
    }

    // ===============================
    // API calls
    // ===============================
    async function fetchScenarioForCurrentMonth() {
      const month = MONTHS[state.round - 1];
      scenarioTextEl.textContent =
        "Asking the AI to come up with a new Hillview situation for this monthâ€¦";
      optionsContainer.innerHTML = "";
      customInput.value = "";
      feedbackText.textContent = "The AI is thinking about your classroomâ€¦";
      feedbackText.classList.remove("error-text");
      submitBtn.disabled = true;

      try {
        const res = await fetch(`${API_BASE}/scenario`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            month,
            round: state.round,
            stats: {
              learningScore: state.learningScore,
              likabilityScore: state.likabilityScore,
              studentsRemaining: state.studentsRemaining,
              classSize: state.classSize
            },
            usedScenarioIds: state.usedScenarioIds
          })
        });

        if (!res.ok) throw new Error("Scenario API error");
        const data = await res.json();

        state.currentScenario = {
          id: data.id,
          title: data.title || month,
          prompt: data.prompt,
          options: Array.isArray(data.options) ? data.options : []
        };

        if (data.id && !state.usedScenarioIds.includes(data.id)) {
          state.usedScenarioIds.push(data.id);
        }

        renderScenario();
      } catch (err) {
        console.error(err);
        scenarioTextEl.textContent =
          "The AI couldn't be reached right now. Try again in a bit, or reload the page.";
        optionsContainer.innerHTML = "";
      } finally {
        submitBtn.disabled = false;
      }
    }

    async function callEvaluateAPI(choicePayload) {
      const month = MONTHS[state.round - 1];

      const res = await fetch(`${API_BASE}/evaluate`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          scenarioId: state.currentScenario.id,
          month,
          round: state.round,
          classSize: state.classSize,
          stats: {
            learningScore: state.learningScore,
            likabilityScore: state.likabilityScore,
            studentsRemaining: state.studentsRemaining
          },
          choice: choicePayload
        })
      });

      if (!res.ok) throw new Error("Evaluate API error");
      return res.json();
    }

    // ===============================
    // Scenario render
    // ===============================
    function renderScenario() {
      const scenario = state.currentScenario;
      if (!scenario) return;

      const monthLabel = MONTHS[state.round - 1] || `Month ${state.round}`;
      roundLabel.textContent = `${monthLabel} Â· ${state.round} of ${state.maxRounds}`;
      scenarioTextEl.textContent =
        scenario.prompt || "The AI forgot to send a prompt. Oops.";

      optionsContainer.innerHTML = "";
      (scenario.options || []).forEach((opt, index) => {
        const btn = document.createElement("button");
        btn.className = "option-btn";
        btn.textContent = opt.text;
        btn.dataset.optionId = opt.id || `opt-${index + 1}`;
        btn.addEventListener("click", () => {
          document.querySelectorAll(".option-btn").forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");
          feedbackText.textContent =
            "Option selected. You can still edit or replace it with your own written response.";
          feedbackText.classList.remove("error-text");
        });
        optionsContainer.appendChild(btn);
      });

      customInput.value = "";
      feedbackText.textContent = "Pick an option or write your own response.";
      feedbackText.classList.remove("error-text");

      state.awaitingNextMonth = false;
      submitBtn.textContent = "Submit & see outcome";
    }

    // ===============================
    // Game lifecycle
    // ===============================
    function resetGame() {
      state.classSize = parseInt(classSizeSelect.value, 10) || 22;
      state.studentsRemaining = state.classSize;
      state.maxStudents = state.classSize;
      state.difficultyMultiplier = computeDifficultyFromClassSize(state.classSize);
      state.round = 0;
      state.learningScore = SCORE_START;
      state.likabilityScore = SCORE_START;
      state.lastLearningDelta = 0;
      state.lastLikabilityDelta = 0;
      state.lastStudentsDelta = 0;
      state.history = [];
      state.currentScenario = null;
      state.usedScenarioIds = [];
      state.awaitingNextMonth = false;

      classMetaText.textContent = `${state.classSize} students Â· ${difficultyLabelFromMultiplier(
        state.difficultyMultiplier
      ).replace("Difficulty: ", "")}`;
      logContainer.innerHTML = "";
      updateStatsUI();
      showStartScreen();
    }

    function startYear() {
      state.classSize = parseInt(classSizeSelect.value, 10) || 22;
      state.studentsRemaining = state.classSize;
      state.maxStudents = state.classSize;
      state.difficultyMultiplier = computeDifficultyFromClassSize(state.classSize);
      state.round = 0;
      state.learningScore = SCORE_START;
      state.likabilityScore = SCORE_START;
      state.lastLearningDelta = 0;
      state.lastLikabilityDelta = 0;
      state.lastStudentsDelta = 0;
      state.history = [];
      state.currentScenario = null;
      state.usedScenarioIds = [];
      state.awaitingNextMonth = false;

      classMetaText.textContent = `${state.classSize} students Â· ${difficultyLabelFromMultiplier(
        state.difficultyMultiplier
      ).replace("Difficulty: ", "")}`;

      logContainer.innerHTML = "";
      appendLogEntry({
        monthLabel: "Setup",
        headline: `New year: ${state.classSize} students. Learning and likability start at 50 / 100.`
      });

      nextRound();
      showScenarioScreen();
      updateStatsUI();
    }

    function nextRound() {
      state.round += 1;
      if (state.round > state.maxRounds) {
        renderEndScreen();
        return;
      }
      fetchScenarioForCurrentMonth();
      updateStatsUI();
    }

    // ===============================
    // Submit flow
    // ===============================
    async function handleSubmitClick() {
      if (!state.currentScenario) return;

      if (!state.awaitingNextMonth) {
        const selectedBtn = document.querySelector(".option-btn.selected");
        const rawCustom = customInput.value.trim();

        let choicePayload;
        if (rawCustom) {
          choicePayload = { type: "custom", customText: rawCustom };
        } else if (selectedBtn && selectedBtn.dataset.optionId) {
          choicePayload = { type: "option", optionId: selectedBtn.dataset.optionId };
        } else {
          feedbackText.textContent =
            "Pick an option or write your own response before submitting.";
          feedbackText.classList.add("error-text");
          return;
        }

        submitBtn.disabled = true;
        feedbackText.classList.remove("error-text");
        feedbackText.textContent =
          "The AI is grading your move and updating your classâ€¦";

        try {
          const result = await callEvaluateAPI(choicePayload);

          // Update scores
          state.learningScore = clamp(
            state.learningScore + (result.learningDelta || 0),
            SCORE_MIN,
            SCORE_MAX
          );
          state.likabilityScore = clamp(
            state.likabilityScore + (result.likabilityDelta || 0),
            SCORE_MIN,
            SCORE_MAX
          );
          state.lastLearningDelta = result.learningDelta || 0;
          state.lastLikabilityDelta = result.likabilityDelta || 0;

          // Students
          const deltaStudents = result.studentsDelta || 0;
          const newStudents = clamp(
            state.studentsRemaining + deltaStudents,
            0,
            state.classSize + 10
          );
          state.lastStudentsDelta = newStudents - state.studentsRemaining;
          state.studentsRemaining = newStudents;
          state.maxStudents = Math.max(state.maxStudents, state.studentsRemaining);

          const monthLabel = MONTHS[state.round - 1] || `Month ${state.round}`;
          const commentary =
            result.commentary || "The AI forgot to explain this decision.";
          const headline =
            result.logHeadline ||
            `Learning ${state.lastLearningDelta >= 0 ? "+" : ""}${state.lastLearningDelta}, ` +
              `Likability ${state.lastLikabilityDelta >= 0 ? "+" : ""}${state.lastLikabilityDelta}, ` +
              `Students ${state.lastStudentsDelta >= 0 ? "+" : ""}${state.lastStudentsDelta}.`;

          state.history.push({
            round: state.round,
            monthLabel,
            scenarioId: state.currentScenario.id,
            choicePayload,
            learningDelta: state.lastLearningDelta,
            likabilityDelta: state.lastLikabilityDelta,
            studentsDelta: state.lastStudentsDelta,
            commentary
          });

          appendLogEntry({ monthLabel, headline });
          feedbackText.textContent = commentary;
          feedbackText.classList.remove("error-text");

          updateStatsUI();

          state.awaitingNextMonth = true;
          submitBtn.textContent =
            state.round >= state.maxRounds ? "See final report" : "Go to next month";
        } catch (err) {
          console.error(err);
          feedbackText.textContent =
            "The AI couldn't grade that move right now. Try again or reload the page.";
          feedbackText.classList.add("error-text");
        } finally {
          submitBtn.disabled = false;
        }
      } else {
        state.awaitingNextMonth = false;
        submitBtn.textContent = "Submit & see outcome";

        if (state.round >= state.maxRounds) {
          renderEndScreen();
        } else {
          nextRound();
        }
      }
    }

    // ===============================
    // Events
    // ===============================
    startBtn.addEventListener("click", startYear);
    restartBtn.addEventListener("click", resetGame);
    submitBtn.addEventListener("click", handleSubmitClick);
    playAgainBtn.addEventListener("click", startYear);

    classSizeSelect.addEventListener("change", () => {
      const previewSize = parseInt(classSizeSelect.value, 10) || 22;
      const previewDiff = computeDifficultyFromClassSize(previewSize);
      classMetaText.textContent = `${previewSize} students Â· ${difficultyLabelFromMultiplier(previewDiff)
        .replace("Difficulty: ", "")}`;
    });

    // Init
    resetGame();
  </script>
  </body>
</html>
