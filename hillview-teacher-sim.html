<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hillview Middle School Teacher Simulator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Be a Hillview Middle School teacher for a year. Balance learning, likability, and enrollment across 11 key months." />

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3THX5NYY2B"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-3THX5NYY2B');
  </script>

  <style>
    :root {
      color-scheme: dark;
      --bg: #020617;
      --card-bg: #020617;
      --card-border: rgba(148, 163, 184, 0.5);
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.12);
      --danger: #f97373;
      --danger-soft: rgba(248, 113, 113, 0.12);
      --muted: #6b7280;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.9);
      --radius-lg: 1.5rem;
      --radius-md: 1rem;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0b1120, #020617 50%, #000);
      color: var(--text);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 16px;
    }

    .app-shell {
      width: 100%;
      max-width: 1200px;
      margin: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      border-radius: var(--radius-lg);
      background: linear-gradient(
        135deg,
        rgba(30, 64, 175, 0.45),
        rgba(17, 24, 39, 0.98)
      );
      border: 1px solid rgba(129, 140, 248, 0.5);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(20px);
    }

    header .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    header h1 {
      margin: 0;
      font-size: 1.5rem;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header h1 span.badge {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(191, 219, 254, 0.4);
      background: rgba(15, 23, 42, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #bfdbfe;
    }

    header p {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-soft);
    }

    .header-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .chip {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .chip-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
    }

    main.layout {
      display: grid;
      grid-template-columns: minmax(0, 270px) minmax(0, 1.5fr) minmax(0, 280px);
      gap: 16px;
    }

    @media (max-width: 960px) {
      main.layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: radial-gradient(circle at top left, #0b1120, #020617 55%);
      border-radius: var(--radius-lg);
      padding: 16px 18px;
      border: 1px solid var(--card-border);
      box-shadow: 0 14px 32px rgba(15, 23, 42, 0.8);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      opacity: 0.07;
      background:
        radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.4), transparent 60%),
        radial-gradient(circle at 100% 0%, rgba(129, 140, 248, 0.45), transparent 55%);
      mix-blend-mode: soft-light;
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .card h2 {
      margin: 0 0 8px;
      font-size: 1.05rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #a5b4fc;
    }

    .card h3 {
      margin: 0 0 6px;
      font-size: 0.92rem;
      color: #e5e7eb;
    }

    .card small {
      color: var(--text-soft);
      font-size: 0.8rem;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .pill {
      padding: 3px 9px;
      font-size: 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--text-soft);
      background: rgba(15, 23, 42, 0.9);
    }

    .month-label {
      font-size: 0.85rem;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .progress-bar-shell {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      overflow: hidden;
      border: 1px solid rgba(31, 41, 55, 0.9);
      margin-bottom: 12px;
    }

    .progress-bar-fill {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, #22c55e, #a3e635);
      width: 0%;
      transition: width 0.4s ease;
    }

    .stat-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 4px;
    }

    .stat-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.85rem;
    }

    .stat-label {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-soft);
    }

    .stat-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
    }

    .stat-dot.learning { background: #38bdf8; }
    .stat-dot.likability { background: #f97316; }
    .stat-dot.enrollment { background: #22c55e; }

    .stat-meter-shell {
      flex: 1;
      height: 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      overflow: hidden;
      border: 1px solid rgba(31, 41, 55, 0.9);
    }

    .stat-meter-fill {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, rgba(148, 163, 184, 0.8), #e5e7eb);
      width: 50%;
      transition: width 0.3s ease;
    }

    .stat-value {
      width: 38px;
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-size: 0.82rem;
      color: #e5e7eb;
    }

    .score-summary {
      margin-top: 10px;
      padding: 9px 10px;
      border-radius: var(--radius-md);
      background: rgba(15, 23, 42, 0.95);
      border: 1px dashed rgba(148, 163, 184, 0.8);
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .score-summary strong {
      color: #e5e7eb;
    }

    .scenario-meta {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 8px;
    }

    .scenario-month {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #a5b4fc;
    }

    .scenario-title {
      font-size: 1rem;
      font-weight: 600;
      color: #e5e7eb;
    }

    .scenario-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .scenario-tag {
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-soft);
    }

    .scenario-text {
      font-size: 0.9rem;
      line-height: 1.5;
      color: #d1d5db;
      margin-bottom: 12px;
      white-space: pre-line;
    }

    label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }

    label span.helper {
      text-transform: none;
      letter-spacing: 0;
      font-size: 0.72rem;
      color: var(--text-soft);
    }

    textarea {
      width: 100%;
      min-height: 130px;
      resize: vertical;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.98);
      color: var(--text);
      padding: 10px 11px;
      font-family: inherit;
      font-size: 0.88rem;
      line-height: 1.5;
      outline: none;
      box-shadow: inset 0 0 0 1px transparent;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    textarea:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.6),
        0 0 40px rgba(34, 197, 94, 0.15);
      background: rgba(15, 23, 42, 0.98);
    }

    textarea[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .button-row {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 0.88rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(34, 197, 94, 0.12);
      color: #bbf7d0;
      border: 1px solid rgba(34, 197, 94, 0.7);
      box-shadow: 0 10px 24px rgba(22, 163, 74, 0.45);
      transition: transform 0.08s ease, box-shadow 0.08s ease,
        background 0.08s ease, border-color 0.08s ease;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(22, 163, 74, 0.7);
      background: rgba(34, 197, 94, 0.16);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 6px 18px rgba(22, 163, 74, 0.6);
    }

    button.secondary {
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-soft);
      border-color: rgba(148, 163, 184, 0.8);
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.7);
    }

    button.secondary:hover:not(:disabled) {
      background: rgba(15, 23, 42, 0.98);
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .feedback {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: var(--radius-md);
      font-size: 0.8rem;
      line-height: 1.4;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: var(--text-soft);
    }

    .feedback.good {
      background: var(--accent-soft);
      border-color: rgba(34, 197, 94, 0.9);
      color: #bbf7d0;
    }

    .feedback.bad {
      background: var(--danger-soft);
      border-color: rgba(248, 113, 113, 0.9);
      color: #fee2e2;
    }

    .feedback h4 {
      margin: 0 0 4px;
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .feedback ul {
      margin: 0;
      padding-left: 18px;
    }

    .feedback li {
      margin-bottom: 2px;
    }

    .yearbook-photo-wrapper {
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: #020617;
      margin-bottom: 10px;
      position: relative;
    }

    .yearbook-photo-wrapper img {
      display: block;
      width: 100%;
      height: auto;
      max-height: 170px;
      object-fit: cover;
      filter: saturate(0.9) contrast(1.1);
    }

    .yearbook-caption {
      position: absolute;
      bottom: 4px;
      right: 6px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.88);
      border: 1px solid rgba(148, 163, 184, 0.6);
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-soft);
    }

    .roster-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }

    .roster-header span {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .roster-list {
      margin: 0;
      padding: 0;
      list-style: none;
      max-height: 290px;
      overflow-y: auto;
      padding-right: 4px;
      scrollbar-width: thin;
      scrollbar-color: rgba(148, 163, 184, 0.7) transparent;
    }

    .roster-list::-webkit-scrollbar {
      width: 6px;
    }

    .roster-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .roster-list::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.7);
      border-radius: 999px;
    }

    .roster-item {
      padding: 6px 6px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 4px;
      transition: background 0.12s ease, transform 0.06s ease;
      border: 1px solid transparent;
    }

    .roster-item.spotlight {
      background: rgba(37, 99, 235, 0.16);
      border-color: rgba(59, 130, 246, 0.8);
      transform: translateX(1px);
    }

    .roster-top-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      font-size: 0.83rem;
    }

    .roster-name {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .roster-avatar {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #e5e7eb, #64748b);
      border: 1px solid rgba(148, 163, 184, 0.8);
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #020617;
      font-weight: 600;
    }

    .roster-mood {
      font-size: 0.85rem;
    }

    .roster-meta {
      display: flex;
      gap: 8px;
      font-size: 0.72rem;
      color: var(--text-soft);
    }

    .roster-pill {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
    }

    .final-outcome {
      margin-top: 10px;
      padding: 9px 10px;
      border-radius: var(--radius-md);
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.9);
      font-size: 0.82rem;
      color: var(--text-soft);
    }

    .final-outcome strong {
      color: #e5e7eb;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="title-block">
        <h1>
          Hillview Teacher Simulator
          <span class="badge">Beta</span>
        </h1>
        <p>
          Make it through one chaotic middle-school year. Balance
          <strong>learning</strong>, <strong>likability</strong>, and
          <strong>enrollment</strong> ‚Äî and no, saying ‚Äúthe kids love me‚Äù
          is not a strategy.
        </p>
      </div>
      <div class="header-meta">
        <div class="chip">
          <span class="chip-dot"></span>
          <span>Year 7B homeroom</span>
        </div>
        <div class="chip">
          üéì 11 months ‚Ä¢ single player
        </div>
      </div>
    </header>

    <main class="layout">
      <!-- Left: Stats -->
      <section class="card">
        <div class="card-inner">
          <h2>Year Overview</h2>
          <div class="month-label">
            <span id="monthLabel">Month 1 of 11 ¬∑ August</span>
          </div>
          <div class="progress-bar-shell">
            <div class="progress-bar-fill" id="yearProgress"></div>
          </div>

          <div class="stat-grid">
            <div class="stat-row">
              <div class="stat-label">
                <span class="stat-dot learning"></span>
                <span>Learning</span>
              </div>
              <div class="stat-meter-shell">
                <div class="stat-meter-fill" id="learningMeter"></div>
              </div>
              <div class="stat-value" id="learningValue">50</div>
            </div>
            <div class="stat-row">
              <div class="stat-label">
                <span class="stat-dot likability"></span>
                <span>Likability</span>
              </div>
              <div class="stat-meter-shell">
                <div class="stat-meter-fill" id="likabilityMeter"></div>
              </div>
              <div class="stat-value" id="likabilityValue">50</div>
            </div>
            <div class="stat-row">
              <div class="stat-label">
                <span class="stat-dot enrollment"></span>
                <span>Enrollment</span>
              </div>
              <div class="stat-meter-shell">
                <div class="stat-meter-fill" id="enrollmentMeter"></div>
              </div>
              <div class="stat-value" id="enrollmentValue">50</div>
            </div>
          </div>

          <div class="score-summary" id="scoreSummary">
            Total score: <strong><span id="totalScore">150</span></strong>
            &nbsp;¬∑&nbsp;<span id="scoreTier">‚ÄúPromising Rookie‚Äù</span>
          </div>

          <div class="pill-row">
            <span class="pill">AI-generated scenarios</span>
            <span class="pill">Penalties for fluff &amp; repetition</span>
          </div>
        </div>
      </section>

      <!-- Middle: Scenario & Answer -->
      <section class="card">
        <div class="card-inner">
          <div class="scenario-meta">
            <div>
              <div class="scenario-month" id="scenarioMonth">August ¬∑ Pre-Service</div>
              <div class="scenario-title" id="scenarioTitle">Loading‚Ä¶</div>
            </div>
            <small id="scenarioFocus">Focus: routines ¬∑ relationships</small>
          </div>

          <div class="scenario-tags" id="scenarioTags"></div>

          <div class="scenario-text" id="scenarioText">
            Loading scenario‚Ä¶
          </div>

          <label for="answerInput">
            Your move this month
            <span class="helper">
              Be concrete. Recycled ‚Äúkids love me‚Äù answers get hammered.
            </span>
          </label>
          <textarea
            id="answerInput"
            autocomplete="off"
            spellcheck="true"
            placeholder="Describe what you actually say and do. Include trade-offs between learning, relationships, and enrollment risk."
          ></textarea>

          <div class="button-row">
            <button class="secondary" id="nextButton" disabled>
              Next month ‚Üí
            </button>
            <button id="submitButton">
              Submit month
            </button>
          </div>

          <div class="feedback" id="feedbackBox" style="display:none;"></div>
        </div>
      </section>

      <!-- Right: Yearbook & Roster -->
      <section class="card">
        <div class="card-inner">
          <h2>Homeroom 7B</h2>

          <div class="yearbook-photo-wrapper">
            <!-- One big cursed yearbook photo per ‚Äúyear‚Äù. Swap this file as needed. -->
            <img
              id="yearbookPhoto"
              src="yearbook-photo.jpg"
              alt="Yearbook-style class photo for Homeroom 7B"
            />
            <div class="yearbook-caption" id="yearbookCaption">
              CLASS OF 20<span id="classYearSuffix">3X</span>
            </div>
          </div>

          <div class="roster-header">
            <h3>Roster</h3>
            <span id="rosterMeta">10 students ¬∑ dynamic arcs</span>
          </div>

          <ul class="roster-list" id="rosterList">
            <!-- Populated by JS -->
          </ul>

          <div class="final-outcome" id="finalOutcome" style="display:none;">
            <!-- Filled at game end -->
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    /****************************************************
     * Utility helpers
     ****************************************************/
    function clamp(value, min, max) {
      return Math.max(min, Math.min(max, value));
    }

    function randomChoice(array) {
      return array[Math.floor(Math.random() * array.length)];
    }

    function wordSet(text) {
      return new Set(
        text
          .toLowerCase()
          .split(/[^a-z0-9']+/)
          .filter(Boolean)
      );
    }

    // Jaccard-ish similarity for repetition penalty
    function textSimilarity(a, b) {
      const setA = wordSet(a);
      const setB = wordSet(b);
      if (!setA.size || !setB.size) return 0;
      let common = 0;
      for (const w of setA) {
        if (setB.has(w)) common++;
      }
      return common / Math.min(setA.size, setB.size);
    }

    /****************************************************
     * Weird student names + roles
     ****************************************************/
    const WEIRD_NAME_CHUNKS_FIRST = [
      "Jor", "Jorch", "Boot", "Bootus", "Kendrew", "Zalp", "Trun",
      "Sner", "Gleeb", "Vorz", "Ploop", "Morb", "Elbi", "Yindle",
      "Quib", "Brinty", "Torple", "Zuzu", "Plinko", "Blep", "Snarf"
    ];

    const WEIRD_NAME_CHUNKS_LAST = [
      "Flarp", "Bimble", "Gort", "Snaggs", "Von Blorp", "McCrump",
      "Thimble", "Greeb", "Flonk", "Twitch", "Buckle", "Drimm",
      "Platt", "Skree", "Mump", "Durf", "Greep", "Fluster", "Pint"
    ];

    const STUDENT_ROLES = [
      "perfectionist",
      "class clown",
      "quiet thinker",
      "athlete",
      "gamer",
      "over-scheduled kid",
      "aspiring influencer",
      "shy artist",
      "debater",
      "anxious high-achiever",
      "always late",
      "restless kid in the back"
    ];

    function generateWeirdName() {
      const first = randomChoice(WEIRD_NAME_CHUNKS_FIRST);
      const last = randomChoice(WEIRD_NAME_CHUNKS_LAST);
      return `${first} ${last}`;
    }

    function generateStudents(count = 10) {
      const students = [];
      const usedRoles = new Set();
      for (let i = 0; i < count; i++) {
        let role = randomChoice(STUDENT_ROLES);
        if (usedRoles.has(role)) {
          role = randomChoice(STUDENT_ROLES);
        }
        usedRoles.add(role);

        const name = generateWeirdName();
        const mood = 40 + Math.random() * 20; // 40‚Äì60
        const gpa = 2.2 + Math.random() * 1.2; // 2.2‚Äì3.4
        const risk = 30 + Math.random() * 30; // 30‚Äì60

        students.push({
          id: "s" + i,
          name,
          initials: name
            .split(" ")
            .map((p) => p[0])
            .join("")
            .slice(0, 2)
            .toUpperCase(),
          role,
          mood,            // 0‚Äì100: happiness / buy-in
          gpa,             // 0‚Äì4-ish
          enrollmentRisk: risk // 0‚Äì100: higher = more likely to leave
        });
      }
      return students;
    }

    /****************************************************
     * Month metadata (AI fills in the actual scenario)
     ****************************************************/
    const MONTHS = [
      {
        id: "august",
        label: "August ¬∑ Pre-Service Week",
        focus: "routines ¬∑ relationships",
        defaultTitle: "First Impressions",
        defaultTags: ["Procedures", "Class culture", "First week"]
      },
      {
        id: "september",
        label: "September",
        focus: "classroom management ¬∑ tech",
        defaultTitle: "Chromebooks vs Focus",
        defaultTags: ["Tech", "Off-task behavior", "Boundaries"]
      },
      {
        id: "october",
        label: "October",
        focus: "family communication",
        defaultTitle: "The Parent Email",
        defaultTags: ["Families", "Grades", "Trust"]
      },
      {
        id: "november",
        label: "November",
        focus: "group work equity",
        defaultTitle: "Group Work Gone Sideways",
        defaultTags: ["Group work", "Equity", "Participation"]
      },
      {
        id: "december",
        label: "December",
        focus: "culture & inclusion",
        defaultTitle: "Holiday Landmines",
        defaultTags: ["Holidays", "Belonging", "Sensitive topics"]
      },
      {
        id: "january",
        label: "January",
        focus: "mid-year reset",
        defaultTitle: "Reset Button",
        defaultTags: ["Reset", "Routines", "Academic push"]
      },
      {
        id: "february",
        label: "February",
        focus: "conflict ¬∑ discipline",
        defaultTitle: "Blowup in 3rd Period",
        defaultTags: ["Student conflict", "Restorative", "Discipline"]
      },
      {
        id: "march",
        label: "March",
        focus: "academic rigor",
        defaultTitle: "Rigor vs Burnout",
        defaultTags: ["Rigor", "Assessment", "Motivation"]
      },
      {
        id: "april",
        label: "April",
        focus: "testing season",
        defaultTitle: "The Big Test",
        defaultTags: ["Testing", "Anxiety", "Pressure"]
      },
      {
        id: "may",
        label: "May",
        focus: "end-of-year behavior",
        defaultTitle: "Spring Chaos",
        defaultTags: ["Behavior", "Fatigue", "Consistency"]
      },
      {
        id: "june",
        label: "June",
        focus: "closure & reflection",
        defaultTitle: "Last Week of School",
        defaultTags: ["Closure", "Reflection", "Legacy"]
      }
    ];

    /****************************************************
     * Game state
     ****************************************************/
    const state = {
      monthIndex: 0,
      learning: 50,
      likability: 50,
      enrollment: 50,
      totalScore: 150,
      previousAnswers: [],
      students: generateStudents(10),
      currentScenario: null,
      lastSpotlightIds: []
    };

    /****************************************************
     * DOM references
     ****************************************************/
    const monthLabelEl = document.getElementById("monthLabel");
    const yearProgressEl = document.getElementById("yearProgress");
    const learningMeterEl = document.getElementById("learningMeter");
    const likabilityMeterEl = document.getElementById("likabilityMeter");
    const enrollmentMeterEl = document.getElementById("enrollmentMeter");
    const learningValueEl = document.getElementById("learningValue");
    const likabilityValueEl = document.getElementById("likabilityValue");
    const enrollmentValueEl = document.getElementById("enrollmentValue");
    const totalScoreEl = document.getElementById("totalScore");
    const scoreTierEl = document.getElementById("scoreTier");

    const scenarioMonthEl = document.getElementById("scenarioMonth");
    const scenarioTitleEl = document.getElementById("scenarioTitle");
    const scenarioFocusEl = document.getElementById("scenarioFocus");
    const scenarioTagsEl = document.getElementById("scenarioTags");
    const scenarioTextEl = document.getElementById("scenarioText");

    const answerInputEl = document.getElementById("answerInput");
    const submitButtonEl = document.getElementById("submitButton");
    const nextButtonEl = document.getElementById("nextButton");
    const feedbackBoxEl = document.getElementById("feedbackBox");

    const classYearSuffixEl = document.getElementById("classYearSuffix");
    const rosterMetaEl = document.getElementById("rosterMeta");
    const rosterListEl = document.getElementById("rosterList");
    const finalOutcomeEl = document.getElementById("finalOutcome");

    /****************************************************
     * Initial setup
     ****************************************************/
    function initYearbookCaption() {
      const base = 30 + Math.floor(Math.random() * 10); // 2030‚Äì2039 vibe
      classYearSuffixEl.textContent = String(base);
    }

    function renderStats() {
      const monthNumber = state.monthIndex + 1;
      const totalMonths = MONTHS.length;
      monthLabelEl.textContent = `Month ${monthNumber} of ${totalMonths} ¬∑ ${MONTHS[state.monthIndex].label.split("¬∑")[0].trim()}`;
      const progressPct = ((state.monthIndex) / (totalMonths - 1)) * 100;
      yearProgressEl.style.width = `${clamp(progressPct, 0, 100)}%`;

      const l = clamp(state.learning, 0, 100);
      const li = clamp(state.likability, 0, 100);
      const e = clamp(state.enrollment, 0, 100);

      learningMeterEl.style.width = `${l}%`;
      likabilityMeterEl.style.width = `${li}%`;
      enrollmentMeterEl.style.width = `${e}%`;

      learningValueEl.textContent = Math.round(l);
      likabilityValueEl.textContent = Math.round(li);
      enrollmentValueEl.textContent = Math.round(e);

      state.totalScore = Math.round(l + li + e);
      totalScoreEl.textContent = state.totalScore;

      let tier = "‚ÄúPromising Rookie‚Äù";
      if (state.totalScore >= 260) tier = "‚ÄúBeloved Wizard Teacher‚Äù";
      else if (state.totalScore >= 230) tier = "‚ÄúCampus Legend‚Äù";
      else if (state.totalScore >= 200) tier = "‚ÄúTrusted Veteran‚Äù";
      else if (state.totalScore <= 150) tier = "‚ÄúOn an Improvement Plan‚Äù";
      scoreTierEl.textContent = tier;
    }

    function renderRoster(spotlightIds = []) {
      rosterListEl.innerHTML = "";
      rosterMetaEl.textContent = `${state.students.length} students ¬∑ dynamic arcs`;

      state.students.forEach((s) => {
        const li = document.createElement("li");
        li.className = "roster-item";
        if (spotlightIds.includes(s.id)) {
          li.classList.add("spotlight");
        }

        const top = document.createElement("div");
        top.className = "roster-top-row";

        const name = document.createElement("div");
        name.className = "roster-name";

        const avatar = document.createElement("div");
        avatar.className = "roster-avatar";
        avatar.textContent = s.initials || "?";

        const label = document.createElement("span");
        label.textContent = s.name;

        name.appendChild(avatar);
        name.appendChild(label);

        const moodEl = document.createElement("div");
        moodEl.className = "roster-mood";
        const mood = s.mood;
        let moodIcon = "üòê";
        if (mood >= 70) moodIcon = "üòÑ";
        else if (mood >= 55) moodIcon = "üôÇ";
        else if (mood <= 35) moodIcon = "üò¨";
        moodEl.textContent = `${moodIcon} ${Math.round(mood)}`;

        top.appendChild(name);
        top.appendChild(moodEl);

        const meta = document.createElement("div");
        meta.className = "roster-meta";

        const role = document.createElement("span");
        role.className = "roster-pill";
        role.textContent = s.role;

        const gpa = document.createElement("span");
        gpa.className = "roster-pill";
        gpa.textContent = `GPA-ish: ${s.gpa.toFixed(1)}`;

        const risk = document.createElement("span");
        risk.className = "roster-pill";
        const riskLabel = s.enrollmentRisk >= 70 ? "High transfer risk" :
          s.enrollmentRisk >= 50 ? "Some transfer chatter" :
          "Likely to stay";
        risk.textContent = riskLabel;

        meta.appendChild(role);
        meta.appendChild(gpa);
        meta.appendChild(risk);

        li.appendChild(top);
        li.appendChild(meta);

        rosterListEl.appendChild(li);
      });
    }

    /****************************************************
     * AI scenario generation
     ****************************************************/
    async function generateScenarioForMonth(monthConfig, students) {
      // This is where you wire in your existing AI generation.
      // Expected response JSON:
      // {
      //   title: string,
      //   text: string,
      //   tags?: string[],
      //   focus?: string,
      //   spotlightIds?: string[]   // subset of students[].id
      // }
      //
      // The prompt on your server should tell the AI:
      // - Use the provided student roster and reference 2‚Äì3 by name.
      // - Keep it 2‚Äì4 paragraphs.
      // - Describe a realistic middle-school situation for that month.
      // - Return JSON in the structure above.

      try {
        const response = await fetch("/api/generate-scenario", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            monthId: monthConfig.id,
            monthLabel: monthConfig.label,
            focus: monthConfig.focus,
            defaultTitle: monthConfig.defaultTitle,
            defaultTags: monthConfig.defaultTags,
            students
          })
        });

        if (response.ok) {
          const data = await response.json();
          return {
            title: data.title || monthConfig.defaultTitle,
            text: data.text || "Your AI scenario text goes here.",
            tags: Array.isArray(data.tags) && data.tags.length ? data.tags : monthConfig.defaultTags,
            focus: data.focus || monthConfig.focus,
            spotlightIds: Array.isArray(data.spotlightIds) ? data.spotlightIds : pickRandomSpotlights(students)
          };
        }
      } catch (err) {
        console.error("Error fetching AI scenario:", err);
      }

      // Fallback if your AI endpoint is down:
      const fallbackSpotlight = pickRandomSpotlights(students);
      const [s1, s2] = fallbackSpotlight.map(
        id => students.find(s => s.id === id) || students[0]
      );
      return {
        title: monthConfig.defaultTitle,
        text:
          `Fallback scenario for ${monthConfig.label}.\n\n` +
          `${s1.name} and ${s2.name} are central to this month's drama. ` +
          `Describe what you do and say to support them while balancing learning, likability, and enrollment.`,
        tags: monthConfig.defaultTags,
        focus: monthConfig.focus,
        spotlightIds: fallbackSpotlight
      };
    }

    function pickRandomSpotlights(students, count = 2) {
      const ids = students.map(s => s.id);
      const out = [];
      while (out.length < count && ids.length) {
        const idx = Math.floor(Math.random() * ids.length);
        out.push(ids.splice(idx, 1)[0]);
      }
      return out;
    }

    async function loadCurrentMonthScenario() {
      const monthConfig = MONTHS[state.monthIndex];

      scenarioMonthEl.textContent = monthConfig.label;
      scenarioTitleEl.textContent = "Loading‚Ä¶";
      scenarioFocusEl.textContent = `Focus: ${monthConfig.focus}`;
      scenarioTagsEl.innerHTML = "";
      scenarioTextEl.textContent = "Asking the AI to generate a scenario for this month‚Ä¶";

      submitButtonEl.disabled = false;
      nextButtonEl.disabled = true;
      answerInputEl.disabled = false;
      feedbackBoxEl.style.display = "none";

      const scenario = await generateScenarioForMonth(monthConfig, state.students);
      state.currentScenario = scenario;
      state.lastSpotlightIds = scenario.spotlightIds || [];

      scenarioTitleEl.textContent = scenario.title;
      scenarioFocusEl.textContent = `Focus: ${scenario.focus}`;
      scenarioTextEl.textContent = scenario.text;

      scenarioTagsEl.innerHTML = "";
      (scenario.tags || []).forEach((tag) => {
        const span = document.createElement("span");
        span.className = "scenario-tag";
        span.textContent = tag;
        scenarioTagsEl.appendChild(span);
      });

      renderRoster(state.lastSpotlightIds);
      renderStats();
    }

    /****************************************************
     * Scoring logic ‚Äì stricter, with fluff & repetition penalties
     ****************************************************/
    const FLUFF_PATTERNS = [
      /kids (love|adore) me/i,
      /the kids love me/i,
      /they're learning (a lot|so much)/i,
      /everything is (great|fine)/i,
      /vibes? are (good|great|immaculate)/i,
      /i'm a (great|good) teacher/i,
      /it'll work itself out/i
    ];

    function analyzeAnswer(answerText) {
      const trimmed = answerText.trim();
      const words = trimmed.split(/\s+/).filter(Boolean);
      const lengthScore = words.length >= 40 ? 1 : words.length >= 20 ? 0 : -1;

      // Does the answer reference any student by name?
      let studentRefs = 0;
      const mentionedStudents = [];
      state.students.forEach((s) => {
        const rx = new RegExp("\\b" + s.name.split(" ")[0] + "\\b", "i");
        if (rx.test(trimmed)) {
          studentRefs++;
          mentionedStudents.push(s.id);
        }
      });

      // "Seriousness" keywords
      const thinkingWords = [
        "plan", "routine", "rubric", "feedback", "call home", "email",
        "conference", "restorative", "reflection", "role", "expectation",
        "call", "family", "guardian", "explicit", "practice"
      ];
      let thinkingHits = 0;
      thinkingWords.forEach((w) => {
        if (trimmed.toLowerCase().includes(w)) thinkingHits++;
      });

      // Tradeoff words
      const tradeoffWords = ["however", "on the other hand", "trade-off", "tradeoff", "balance", "tension", "at the same time"];
      let tradeoffHits = 0;
      tradeoffWords.forEach((w) => {
        if (trimmed.toLowerCase().includes(w)) tradeoffHits++;
      });

      // Fluff penalty
      let fluffPenalty = 0;
      FLUFF_PATTERNS.forEach((rx) => {
        if (rx.test(trimmed)) {
          fluffPenalty -= 7; // each instance hurts
        }
      });

      // Repetition penalty (compare to last few answers)
      let repetitionPenalty = 0;
      state.previousAnswers.slice(-3).forEach((prev) => {
        const sim = textSimilarity(prev, trimmed);
        if (sim > 0.88) {
          repetitionPenalty -= 18; // brutal copy-paste penalty
        } else if (sim > 0.78) {
          repetitionPenalty -= 10;
        }
      });

      // Base quality score: harder to score high
      let quality =
        4 * lengthScore +
        3 * Math.min(studentRefs, 3) +
        2 * Math.min(thinkingHits, 4) +
        3 * Math.min(tradeoffHits, 2) +
        fluffPenalty +
        repetitionPenalty / 2;

      quality = clamp(quality, -18, 18);

      // Map quality to stat deltas. Keep gains modest so high scores are rare.
      let learningDelta = 0;
      let likabilityDelta = 0;
      let enrollmentDelta = 0;

      // Noise so not every similar answer yields identical numbers
      const noise = () => (Math.random() - 0.5) * 1.5;

      if (quality <= -8) {
        learningDelta = -6 + noise();
        likabilityDelta = -5 + noise();
        enrollmentDelta = -5 + noise();
      } else if (quality <= -3) {
        learningDelta = -3 + noise();
        likabilityDelta = -2 + noise();
        enrollmentDelta = -3 + noise();
      } else if (quality <= 2) {
        learningDelta = -1 + noise();
        likabilityDelta = -1 + noise();
        enrollmentDelta = -1 + noise();
      } else if (quality <= 7) {
        learningDelta = 2 + noise();
        likabilityDelta = 1 + noise();
        enrollmentDelta = 1 + noise();
      } else if (quality <= 13) {
        learningDelta = 3.5 + noise();
        likabilityDelta = 2.5 + noise();
        enrollmentDelta = 2 + noise();
      } else {
        // Peak performance, still capped
        learningDelta = 5 + noise();
        likabilityDelta = 3.5 + noise();
        enrollmentDelta = 3 + noise();
      }

      // Slight overall difficulty bump: shrink positive deltas
      if (learningDelta > 0) learningDelta *= 0.8;
      if (likabilityDelta > 0) likabilityDelta *= 0.8;
      if (enrollmentDelta > 0) enrollmentDelta *= 0.8;

      return {
        quality,
        lengthScore,
        studentRefs,
        thinkingHits,
        tradeoffHits,
        fluffPenalty,
        repetitionPenalty,
        deltas: {
          learningDelta,
          likabilityDelta,
          enrollmentDelta
        },
        mentionedStudents
      };
    }

    function applyDeltasToStats(deltas) {
      state.learning = clamp(state.learning + deltas.learningDelta, 0, 100);
      state.likability = clamp(state.likability + deltas.likabilityDelta, 0, 100);
      state.enrollment = clamp(state.enrollment + deltas.enrollmentDelta, 0, 100);
    }

    function applyDeltasToStudents(deltas, mentionedStudents) {
      // Nudge spotlight + mentioned kids a bit more
      const focusIds = new Set([...state.lastSpotlightIds, ...mentionedStudents]);
      state.students.forEach((s) => {
        const weight = focusIds.has(s.id) ? 1.4 : 0.9;

        s.gpa = clamp(
          s.gpa + (deltas.learningDelta / 20) * weight,
          1.5,
          4.1
        );

        s.mood = clamp(
          s.mood + (deltas.likabilityDelta / 2) * weight,
          10,
          100
        );

        s.enrollmentRisk = clamp(
          s.enrollmentRisk - (deltas.enrollmentDelta / 2) * weight,
          0,
          100
        );
      });
    }

    function renderFeedback(analysis) {
      const {
        quality,
        lengthScore,
        studentRefs,
        thinkingHits,
        tradeoffHits,
        fluffPenalty,
        repetitionPenalty,
        deltas
      } = analysis;

      const messages = [];
      if (lengthScore < 0) {
        messages.push("Very short answer ‚Äî felt more like a reaction than a plan.");
      } else if (lengthScore > 0) {
        messages.push("Gave enough detail to see what actually happens in the room.");
      }

      if (studentRefs === 0) {
        messages.push("You didn't reference any students by name ‚Äî 7B felt generic.");
      } else if (studentRefs === 1) {
        messages.push("You connected the plan to at least one specific student.");
      } else {
        messages.push("You grounded your plan in multiple named students.");
      }

      if (thinkingHits > 0) {
        messages.push("You mentioned structures like routines, feedback, or family contact.");
      }

      if (tradeoffHits > 0) {
        messages.push("You acknowledged real trade-offs instead of pretending everything wins.");
      }

      if (fluffPenalty < 0) {
        messages.push("You leaned on fluff like ‚Äúthe kids love me‚Äù instead of specific actions.");
      }

      if (repetitionPenalty < 0) {
        messages.push("Answer was very similar to something you said in a previous month.");
      }

      const overall =
        quality <= -8
          ? "This month went sideways. Kids, parents, and admin all felt it."
          : quality <= -3
          ? "You survived the month, but at a noticeable cost to the classroom."
          : quality <= 2
          ? "Neutral month. Nothing on fire, but not much moved forward either."
          : quality <= 8
          ? "Solid month ‚Äî students felt the impact of your choices."
          : quality <= 13
          ? "Strong month ‚Äî you threaded some tough trade-offs."
          : "Peak month. This is the kind of move people talk about in June.";

      feedbackBoxEl.style.display = "block";
      feedbackBoxEl.classList.remove("good", "bad");
      if (quality >= 3) feedbackBoxEl.classList.add("good");
      if (quality <= -3) feedbackBoxEl.classList.add("bad");

      const learningChange = deltas.learningDelta.toFixed(1);
      const likeChange = deltas.likabilityDelta.toFixed(1);
      const enrollChange = deltas.enrollmentDelta.toFixed(1);

      feedbackBoxEl.innerHTML = `
        <h4>Month outcome</h4>
        <p>${overall}</p>
        <ul>
          <li>Learning: ${learningChange > 0 ? "+" : ""}${learningChange}</li>
          <li>Likability: ${likeChange > 0 ? "+" : ""}${likeChange}</li>
          <li>Enrollment: ${enrollChange > 0 ? "+" : ""}${enrollChange}</li>
        </ul>
        <p>${messages.join("<br/>")}</p>
      `;
    }

    /****************************************************
     * End-of-year summary
     ****************************************************/
    function renderFinalOutcome() {
      const L = state.learning;
      const LI = state.likability;
      const E = state.enrollment;

      let summary = "";
      if (L >= 70 && LI >= 70 && E >= 70) {
        summary = "You pulled off the unicorn year: high learning, kids mostly like you, and families stay put.";
      } else if (L >= 70 && LI < 50) {
        summary = "Academically strong, but a lot of kids will remember this as their ‚Äòtough teacher‚Äô year.";
      } else if (L < 50 && LI >= 70) {
        summary = "They'll miss you, but next year's teacher is going to ask some questions about those gaps.";
      } else if (E < 50) {
        summary = "Enough families considered transferring that admin will want to debrief next year.";
      } else {
        summary = "It was a mixed year ‚Äî some bright spots, some bruises, lots to learn from.";
      }

      finalOutcomeEl.style.display = "block";
      finalOutcomeEl.innerHTML = `
        <strong>Year summary</strong><br/>
        Learning: ${Math.round(L)} ¬∑ Likability: ${Math.round(LI)} ¬∑ Enrollment: ${Math.round(E)}<br/><br/>
        ${summary}
      `;
    }

    /****************************************************
     * Event handlers
     ****************************************************/
    submitButtonEl.addEventListener("click", () => {
      const text = answerInputEl.value.trim();
      if (!text) {
        alert("Give your students something more than silence.");
        return;
      }

      const analysis = analyzeAnswer(text);
      applyDeltasToStats(analysis.deltas);
      applyDeltasToStudents(analysis.deltas, analysis.mentionedStudents);
      renderStats();
      renderRoster(state.lastSpotlightIds);
      renderFeedback(analysis);

      state.previousAnswers.push(text);

      submitButtonEl.disabled = true;
      answerInputEl.disabled = true;
      nextButtonEl.disabled = state.monthIndex >= MONTHS.length - 1;
    });

    nextButtonEl.addEventListener("click", () => {
      if (state.monthIndex >= MONTHS.length - 1) return;
      state.monthIndex += 1;
      answerInputEl.value = "";
      feedbackBoxEl.style.display = "none";
      submitButtonEl.disabled = false;
      answerInputEl.disabled = false;
      nextButtonEl.disabled = true;
      loadCurrentMonthScenario().then(() => {
        if (state.monthIndex === MONTHS.length - 1) {
          // Last month will show summary after submit.
        }
      });
    });

    /****************************************************
     * Kick off
     ****************************************************/
    (function startGame() {
      initYearbookCaption();
      renderStats();
      renderRoster();
      loadCurrentMonthScenario().then(() => {
        // When last month is submitted, show final outcome
        const observer = new MutationObserver(() => {
          if (state.monthIndex === MONTHS.length - 1 && submitButtonEl.disabled) {
            renderFinalOutcome();
          }
        });
        observer.observe(feedbackBoxEl, { childList: true, subtree: true });
      });
    })();
  </script>
</body>
</html>
